name: Generate BACnet Profile from Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  generate-profile:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'new-device')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd automation
          pip install -r requirements.txt
          cd ../scripts && npm install

      - name: Save issue body to file
        run: |
          mkdir -p automation/temp
          cat > automation/temp/issue-body.txt << 'EOF'
          ${{ github.event.issue.body }}
          EOF

      - name: Debug GitHub event
        run: |
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo ""
          echo "=== Raw Issue Body ==="
          echo '${{ github.event.issue.body }}'
          echo "=== End Raw Body ==="
    
      - name: Run Agent
        env:
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          cd automation
          python scripts/run-agent.py \
            --issue-body-file temp/issue-body.txt \
            --issue-number ${{ github.event.issue.number }}

      - name: Check generated files
        id: check_files
        run: |
          if [ -f automation/temp/generated-files-list.txt ]; then
            echo "files_found=true" >> $GITHUB_OUTPUT
            echo "Generated files:"
            cat automation/temp/generated-files-list.txt
          else
            echo "files_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_files.outputs.files_found == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add BACnet profile for issue #${{ github.event.issue.number }}"
          title: "Add: BACnet profile from issue #${{ github.event.issue.number }}"
          body: |
            This PR was automatically generated from issue #${{ github.event.issue.number }}
            
            **Changes:**
            - Added new BACnet device profile
            - Generated test data and expected outputs
            - Created CHANGELOG.md
            
            **Validation:**
            - [ ] Profile YAML syntax validated
            - [ ] Codec functions tested
            - [ ] Test data generated successfully
            
            Please review the generated profile before merging.
          branch: auto-profile-${{ github.event.issue.number }}
          delete-branch: true

      - name: Comment on Issue
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          cd automation
          python scripts/comment-on-issue.py ${{ github.event.issue.number }}
